name: Duplicate Release to Another Repo

on:
  push:
    branches:
      - master
  workflow_dispatch:

jobs:
  duplicate-release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Generate GitHub App Token
        id: get-token
        uses: tibdex/github-app-token@v2
        with:
          app_id: ${{ secrets.APP_ID }}
          private_key: ${{ secrets.APP_PRIVATE_KEY }}
          installation_id: ${{ secrets.APP_INSTALLATION_ID }}
      
      - name: Install dependencies
        run: sudo apt-get install -y jq curl
        
      - name: Get latest release and download assets
        env:
          GH_TOKEN: ${{ steps.get-token.outputs.token }}
        run: |
          # Define repositories
          SOURCE_REPO="Dawascope-Technologies/Desktop_POS_Server"
          TARGET_REPO="Dawascope-Technologies/dw_builds"
          
          echo "Fetching latest release from $SOURCE_REPO..."
          
          # Fetch latest release info
          RELEASE=$(curl -sL \
            -H "Authorization: Bearer $GH_TOKEN" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/$SOURCE_REPO/releases/latest")
          
          # Save release data
          echo "$RELEASE" > release_data.json
          
          # Create downloads directory
          mkdir -p ./downloads
          
          echo "Downloading asset using GitHub CLI..."
          # Use gh release download which handles authentication correctly
          gh release download --repo $SOURCE_REPO $(echo "$RELEASE" | jq -r '.tag_name') \
            --pattern "*.exe" \
            --dir ./downloads
          
          # List downloaded files
          echo "Downloaded files:"
          ls -l ./downloads
          
          # Get expected size from release data
          EXPECTED_SIZE=$(echo "$RELEASE" | jq -r '.assets[0].size')
          echo "Expected size: $EXPECTED_SIZE"
          
          # Get actual file size using wc instead of stat
          ACTUAL_SIZE=$(wc -c < "./downloads/"*.exe)
          echo "Actual size: $ACTUAL_SIZE"
          
          # Compare sizes numerically
          if [ "$ACTUAL_SIZE" -eq "$EXPECTED_SIZE" ]; then
            echo "File size verification successful"
          else
            echo "Size mismatch. Expected: $EXPECTED_SIZE, Got: $ACTUAL_SIZE"
            exit 1
          fi
      
      - name: Create and upload to target release
        env:
          GH_TOKEN: ${{ steps.get-token.outputs.token }}
        run: |
          TARGET_REPO="Dawascope-Technologies/dw_builds"
          
          # Load release data
          RELEASE_DATA=$(cat release_data.json)
          RELEASE_TAG=$(echo "$RELEASE_DATA" | jq -r .tag_name)
          RELEASE_NAME=$(echo "$RELEASE_DATA" | jq -r .name)
          
          echo "Creating release in target repository..."
          
          # Create release using gh cli
          gh release create "$RELEASE_TAG" \
            --repo "$TARGET_REPO" \
            --title "$RELEASE_NAME" \
            --notes "Duplicated from source repository" \
            ./downloads/*.exe