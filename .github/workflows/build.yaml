name: Fetch Latest Releases

on:
  push:
    branches:
      - master  # Trigger on pushes to master
jobs:
  fetch-releases:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: sudo apt-get install -y jq curl

      - name: Get latest releases and download .exe files
        run: |
          # List of repositories to fetch releases for
          REPOS=("owner1/repo1" "owner2/repo2" "owner3/repo3")  # Add more repositories as needed

          # Initialize summary file
          echo "# Latest Releases" > releases.md
          mkdir -p downloaded_executables

          # Iterate over each repository
          for REPO in "${REPOS[@]}"; do
            echo "Fetching latest release from $REPO"
            
            # Fetch release details
            RELEASE=$(curl -s "https://api.github.com/repos/$REPO/releases/latest")
            RELEASE_TAG=$(echo $RELEASE | jq -r .tag_name)
            RELEASE_NAME=$(echo $RELEASE | jq -r .name)
            RELEASE_URL=$(echo $RELEASE | jq -r .html_url)

            # Fetch assets (look for .exe files)
            ASSETS=$(echo $RELEASE | jq -r '.assets[] | select(.name | endswith(".exe")) | {name: .name, url: .browser_download_url}')
            ASSET_NAME=$(echo $ASSETS | jq -r .name)
            ASSET_URL=$(echo $ASSETS | jq -r .url)

            # Download .exe file if available
            if [ -n "$ASSET_URL" ]; then
              echo "Downloading $ASSET_NAME from $ASSET_URL"
              curl -L -o "downloaded_executables/$ASSET_NAME" "$ASSET_URL"
              echo "Downloaded $ASSET_NAME successfully."
            else
              echo "No .exe file found for $REPO."
            fi

            # Append details to summary file
            echo "## $REPO" >> releases.md
            echo "- Version: $RELEASE_TAG" >> releases.md
            echo "- Name: $RELEASE_NAME" >> releases.md
            echo "- URL: $RELEASE_URL" >> releases.md
            if [ -n "$ASSET_NAME" ]; then
              echo "- Downloaded File: $ASSET_NAME" >> releases.md
            else
              echo "- No .exe file found in the release." >> releases.md
            fi
            echo "" >> releases.md
          done

          # Display summary in workflow
          cat releases.md

      - name: Upload summary and executables as artifacts
        uses: actions/upload-artifact@v3
        with:
          name: release-summary
          path: releases.md
          retention-days: 30

      - name: Upload executables as artifact
        uses: actions/upload-artifact@v3
        with:
          name: executables
          path: downloaded_executables/
          retention-days: 30
